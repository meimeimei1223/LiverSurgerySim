name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-linux:
    name: Linux Build
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake ninja-build \
          libgl1-mesa-dev libglew-dev libglfw3-dev libfreetype-dev \
          fuse libfuse2

    - name: Build
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DUSE_GEOGRAM=OFF
        make -j$(nproc)

    - name: Create AppImage
      run: |
        EXE=$(find build -name "LiverSurgerySim" -type f | head -1)
        mkdir -p AppDir/usr/bin
        cp "$EXE" AppDir/usr/bin/
        chmod +x AppDir/usr/bin/LiverSurgerySim
        for dir in model shader shaders data; do
          [ -d "$dir" ] && cp -r "$dir" AppDir/usr/bin/
        done
        cat > AppDir/LiverSurgerySim.desktop << 'DESK'
[Desktop Entry]
Type=Application
Name=Liver Surgery Simulator
Exec=LiverSurgerySim
Icon=LiverSurgerySim
Categories=Science;
Terminal=false
DESK
        cat > AppDir/LiverSurgerySim.svg << 'ICON'
<?xml version="1.0"?><svg width="256" height="256" xmlns="http://www.w3.org/2000/svg"><rect width="256" height="256" fill="#8B0000" rx="40"/><text x="128" y="170" font-size="140" text-anchor="middle" fill="white">ËÇù</text></svg>
ICON
        cat > AppDir/AppRun << 'RUN'
#!/bin/bash
HERE="$(dirname "$(readlink -f "$0")")"
export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
cd "${HERE}/usr/bin"
exec ./LiverSurgerySim "$@"
RUN
        chmod +x AppDir/AppRun
        wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
        chmod +x appimagetool
        ARCH=x86_64 ./appimagetool --appimage-extract-and-run AppDir LiverSurgerySim-linux-x86_64.AppImage

    - uses: actions/upload-artifact@v4
      with:
        name: linux-appimage
        path: LiverSurgerySim-*.AppImage

  build-windows:
    name: Windows Build
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '962e5e39f8a25f42522f51fffc574e05a3efd26b'

    - name: Build
      run: |
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" -DVCPKG_TARGET_TRIPLET=x64-windows -DUSE_GEOGRAM=OFF
        cmake --build build --config Release --parallel

    - name: Package
      shell: pwsh
      run: |
        $OUT = "dist/LiverSurgerySim-windows-x64"
        New-Item -ItemType Directory -Force -Path $OUT
        $exe = Get-ChildItem -Path "build" -Recurse -Filter "LiverSurgerySim.exe" | Select-Object -First 1
        Copy-Item $exe.FullName -Destination $OUT
        Get-ChildItem "$env:VCPKG_ROOT/installed/x64-windows/bin/*.dll" | Copy-Item -Destination $OUT
        @("model","shader","shaders","data") | ForEach-Object { if(Test-Path $_){Copy-Item -Recurse $_ -Destination "$OUT/$_"} }
        Compress-Archive -Path "$OUT/*" -DestinationPath "LiverSurgerySim-windows-x64.zip"

    - uses: actions/upload-artifact@v4
      with:
        name: windows-package
        path: LiverSurgerySim-windows-x64.zip
