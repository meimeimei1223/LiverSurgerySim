name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-linux:
    name: Linux Build
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake ninja-build libgl1-mesa-dev libglew-dev libglfw3-dev libfreetype-dev fuse libfuse2

    - name: Build
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DUSE_GEOGRAM=OFF
        make -j$(nproc)

    - name: Create AppImage
      run: |
        EXE=$(find build -name "LiverSurgerySim" -type f | head -1)
        mkdir -p AppDir/usr/bin
        cp "$EXE" AppDir/usr/bin/
        chmod +x AppDir/usr/bin/LiverSurgerySim
        for dir in model shader shaders data; do
          [ -d "$dir" ] && cp -r "$dir" AppDir/usr/bin/
        done
        echo '[Desktop Entry]' > AppDir/LiverSurgerySim.desktop
        echo 'Type=Application' >> AppDir/LiverSurgerySim.desktop
        echo 'Name=Liver Surgery Simulator' >> AppDir/LiverSurgerySim.desktop
        echo 'Exec=LiverSurgerySim' >> AppDir/LiverSurgerySim.desktop
        echo 'Icon=LiverSurgerySim' >> AppDir/LiverSurgerySim.desktop
        echo 'Categories=Science;' >> AppDir/LiverSurgerySim.desktop
        echo 'Terminal=false' >> AppDir/LiverSurgerySim.desktop
        echo '#!/bin/bash' > AppDir/AppRun
        echo 'HERE="$(dirname "$(readlink -f "$0")")"' >> AppDir/AppRun
        echo 'cd "${HERE}/usr/bin"' >> AppDir/AppRun
        echo 'exec ./LiverSurgerySim "$@"' >> AppDir/AppRun
        chmod +x AppDir/AppRun
        touch AppDir/LiverSurgerySim.svg
        wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
        chmod +x appimagetool
        ARCH=x86_64 ./appimagetool --appimage-extract-and-run AppDir LiverSurgerySim-linux-x86_64.AppImage

    - uses: actions/upload-artifact@v4
      with:
        name: linux-appimage
        path: LiverSurgerySim-*.AppImage

  build-windows:
    name: Windows Build
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '962e5e39f8a25f42522f51fffc574e05a3efd26b'

    - name: Build
      run: |
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" -DVCPKG_TARGET_TRIPLET=x64-windows -DUSE_GEOGRAM=OFF
        cmake --build build --config Release --parallel

    - name: Package
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path dist
        $exe = Get-ChildItem -Path build -Recurse -Filter LiverSurgerySim.exe | Select-Object -First 1
        Copy-Item $exe.FullName -Destination dist/
        if (Test-Path "$env:VCPKG_ROOT/installed/x64-windows/bin") {
          Get-ChildItem "$env:VCPKG_ROOT/installed/x64-windows/bin/*.dll" | Copy-Item -Destination dist/
        }
        if (Test-Path model) { Copy-Item -Recurse model -Destination dist/ }
        if (Test-Path shader) { Copy-Item -Recurse shader -Destination dist/ }
        if (Test-Path shaders) { Copy-Item -Recurse shaders -Destination dist/ }
        if (Test-Path data) { Copy-Item -Recurse data -Destination dist/ }
        Compress-Archive -Path dist/* -DestinationPath LiverSurgerySim-windows-x64.zip

    - uses: actions/upload-artifact@v4
      with:
        name: windows-package
        path: LiverSurgerySim-windows-x64.zip
